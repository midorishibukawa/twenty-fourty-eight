image: nixpkgs/nix-flakes:latest
stages:
  - build_bin
variables:
  CACHIX_CACHE_NAME: midorishibukawa-ml
  PROJECT_NAME: twenty_fourty_eight
  
.before_script_cachix:
  before_script:
    - nix profile install --accept-flake-config nixpkgs#cachix
    - cachix use "$CACHIX_CACHE_NAME"
    
build_n_test:
  stage: build_bin
  extends: .before_script_cachix
  coverage: '/Coverage: \d*\/\d* \((.*)%\)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: cobertura.xml
    paths:
      - twenty_fourty_eight
      - public
  script:
    - cachix watch-exec $CACHIX_CACHE_NAME -- nix build .#prd
    - cp result/bin/$PROJECT_NAME .
    - export BISECT_FILE=${PWD}/cobertura
    - cachix watch-exec $CACHIX_CACHE_NAME -- nix develop -c make test
    - cachix watch-exec $CACHIX_CACHE_NAME -- nix develop -c bisect-ppx-report cobertura cobertura.xml
    - cachix watch-exec $CACHIX_CACHE_NAME --  nix develop -c make doc
    - mkdir -p public && cp -r _build/default/_doc/_html/* public